<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Entry Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-success { color: #10b981; }
        .status-error { color: #ef4444; }
        .status-info { color: #3b82f6; }
        .config-step {
            border-left: 4px solid #3b82f6;
            background-color: #eff6ff;
            padding: 12px;
            margin: 8px 0;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Data Entry Dashboard</h1>
            <p class="text-gray-600">Enter data and save it directly to Google Sheets</p>
        </div>

        <!-- Enhanced Configuration Panel -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Configuration & Setup</h2>
            
            <!-- Current URL Display -->
            <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-6">
                <h3 class="text-sm font-medium text-blue-800 mb-2">Current URL Information:</h3>
                <p class="text-sm text-blue-700">
                    <strong>Origin:</strong> <code class="bg-white px-2 py-1 rounded" id="currentOrigin"></code>
                </p>
                <p class="text-sm text-blue-700 mt-1">
                    <strong>Full URL:</strong> <code class="bg-white px-2 py-1 rounded" id="currentURL"></code>
                </p>
            </div>

            <!-- Detailed Setup Instructions -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-6">
                <h3 class="text-sm font-medium text-yellow-800 mb-3">Complete Setup Instructions:</h3>
                
                <div class="config-step">
                    <h4 class="font-medium text-gray-800">Step 1: Google Cloud Console</h4>
                    <p class="text-sm text-gray-600 mt-1">Go to <a href="https://console.cloud.google.com" target="_blank" class="underline text-blue-600">Google Cloud Console</a></p>
                </div>

                <div class="config-step">
                    <h4 class="font-medium text-gray-800">Step 2: Enable API</h4>
                    <p class="text-sm text-gray-600 mt-1">Navigate to APIs & Services ‚Üí Library ‚Üí Search for "Google Sheets API" ‚Üí Enable it</p>
                </div>

                <div class="config-step">
                    <h4 class="font-medium text-gray-800">Step 3: Create OAuth Client</h4>
                    <p class="text-sm text-gray-600 mt-1">Go to APIs & Services ‚Üí Credentials ‚Üí Create Credentials ‚Üí OAuth client ID ‚Üí Web application</p>
                </div>

                <div class="config-step">
                    <h4 class="font-medium text-gray-800">Step 4: Configure Authorized Origins (CRITICAL)</h4>
                    <p class="text-sm text-gray-600 mt-1">Add these to "Authorized JavaScript origins":</p>
                    <ul class="text-xs text-gray-600 mt-2 space-y-1">
                        <li>‚Ä¢ <code class="bg-white px-1 rounded">https://muditha23.github.io</code></li>
                        <li>‚Ä¢ <code class="bg-white px-1 rounded">http://localhost</code></li>
                        <li>‚Ä¢ <code class="bg-white px-1 rounded">http://127.0.0.1</code></li>
                        <li>‚Ä¢ <code class="bg-white px-1 rounded" id="dynamicOrigin"></code></li>
                    </ul>
                </div>

                <div class="config-step">
                    <h4 class="font-medium text-gray-800">Step 5: Create Google Sheet</h4>
                    <p class="text-sm text-gray-600 mt-1">Create a new Google Sheet with these exact headers in row 1:</p>
                    <p class="text-xs text-gray-600 mt-1 font-mono bg-white p-2 rounded">Name | Email | Phone | Message | Timestamp</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">OAuth2 Client ID</label>
                    <input type="text" id="clientId" 
                           placeholder="Your-Client-ID.apps.googleusercontent.com"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Get this from Google Cloud Console ‚Üí Credentials</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Google Sheet ID</label>
                    <input type="text" id="sheetId" 
                           placeholder="Get from Google Sheet URL"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Found in the URL between /d/ and /edit</p>
                </div>
            </div>
            
            <div class="mt-6 flex flex-wrap gap-3">
                <button onclick="initializeGoogleAPI()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition duration-200 font-medium">
                    üîê Initialize & Sign In
                </button>
                <button onclick="testSheetAccess()" 
                        class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-md transition duration-200 font-medium">
                    üß™ Test Sheet Access
                </button>
                <button onclick="signOut()" 
                        class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-md transition duration-200 font-medium">
                    üö™ Sign Out
                </button>
            </div>
            <div id="authStatus" class="mt-4"></div>
        </div>

        <!-- Data Entry Form -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">üìù Add New Entry</h2>
            <form id="dataForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                        <input type="text" id="name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="email" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                        <input type="tel" id="phone" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                    <textarea id="message" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical"></textarea>
                </div>
                <button type="submit" id="submitBtn"
                        class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-md transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                    üíæ Save to Google Sheet
                </button>
            </form>
            <div id="formStatus" class="mt-4"></div>
        </div>

        <!-- Data Display -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-3">
                <h2 class="text-xl font-semibold text-gray-800">üìä Current Data</h2>
                <div class="flex gap-2">
                    <button onclick="loadData()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition duration-200 text-sm">
                        üîÑ Refresh Data
                    </button>
                    <button onclick="exportData()" 
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition duration-200 text-sm">
                        üì• Export CSV
                    </button>
                </div>
            </div>
            <div id="dataContainer">
                <div class="bg-gray-50 border border-gray-200 rounded-md p-6 text-center">
                    <p class="text-gray-500 mb-2">üîê Sign in and connect to view your Google Sheet data</p>
                    <p class="text-xs text-gray-400">Configure your OAuth settings above and click "Initialize & Sign In"</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let SHEET_ID = '';
        let isSignedIn = false;
        let tokenClient = null;
        let accessToken = null;
        let currentData = [];

        // Display current URL information
        function updateURLInfo() {
            document.getElementById('currentOrigin').textContent = window.location.origin;
            document.getElementById('currentURL').textContent = window.location.href;
            document.getElementById('dynamicOrigin').textContent = window.location.origin;
        }

        // Enhanced Google API initialization with better error handling
        async function initializeGoogleAPI() {
            const clientId = document.getElementById('clientId').value.trim();
            SHEET_ID = document.getElementById('sheetId').value.trim();
            
            if (!clientId || !SHEET_ID) {
                showStatus('authStatus', 'Please enter both Client ID and Sheet ID', 'error');
                return;
            }

            showStatus('authStatus', 'üîÑ Initializing Google API...', 'info');

            try {
                // Load the Google API client
                await new Promise((resolve, reject) => {
                    gapi.load('client', { 
                        callback: resolve, 
                        onerror: () => reject(new Error('Failed to load Google API client'))
                    });
                });

                // Initialize the GAPI client
                await gapi.client.init({
                    clientId: clientId,
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                    scope: 'https://www.googleapis.com/auth/spreadsheets'
                });

                // Initialize the token client for OAuth2 with improved configuration
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: clientId,
                    scope: 'https://www.googleapis.com/auth/spreadsheets',
                    prompt: 'consent',
                    callback: (response) => {
                        console.log('Auth response:', response);
                        
                        if (response.error) {
                            let errorMessage = `Authentication failed: ${response.error}`;
                            
                            if (response.error === 'redirect_uri_mismatch') {
                                errorMessage += `. Please add "${window.location.origin}" to your OAuth2 client's authorized JavaScript origins in Google Cloud Console.`;
                            }
                            
                            showStatus('authStatus', errorMessage, 'error');
                            console.error('Token error:', response);
                            return;
                        }
                        
                        accessToken = response.access_token;
                        gapi.client.setToken({access_token: accessToken});
                        handleSignIn();
                    },
                    error_callback: (error) => {
                        console.error('OAuth error:', error);
                        showStatus('authStatus', `OAuth error: ${error.message || 'Unknown authentication error'}`, 'error');
                    }
                });

                showStatus('authStatus', '‚úÖ API initialized. Requesting permissions...', 'info');
                
                // Request access token
                tokenClient.requestAccessToken({
                    prompt: 'consent'
                });

            } catch (error) {
                console.error('Init error:', error);
                
                let errorMessage = `Initialization error: ${error.message || 'Unknown error'}`;
                
                if (error.message && error.message.includes('origin')) {
                    errorMessage += `. Make sure "${window.location.origin}" is added to your OAuth2 client's authorized JavaScript origins.`;
                }
                
                showStatus('authStatus', errorMessage, 'error');
            }
        }

        // Handle successful sign in
        async function handleSignIn() {
            isSignedIn = true;
            showStatus('authStatus', 'üéâ Successfully authenticated! Testing sheet access...', 'info');
            document.getElementById('submitBtn').disabled = false;
            
            // Test sheet access immediately after sign in
            await testSheetAccess(true);
            
            if (isSignedIn) {
                loadData();
            }
        }

        // Enhanced sign out
        function signOut() {
            try {
                if (accessToken) {
                    google.accounts.oauth2.revoke(accessToken);
                }
                
                isSignedIn = false;
                accessToken = null;
                gapi.client.setToken(null);
                
                showStatus('authStatus', 'üëã Signed out successfully', 'info');
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('dataContainer').innerHTML = `
                    <div class="bg-gray-50 border border-gray-200 rounded-md p-6 text-center">
                        <p class="text-gray-500">üîê Sign in to view your Google Sheet data</p>
                    </div>
                `;
            } catch (error) {
                console.error('Sign out error:', error);
                showStatus('authStatus', 'Sign out completed with warnings', 'info');
            }
        }

        // Enhanced sheet access test
        async function testSheetAccess(silent = false) {
            if (!isSignedIn) {
                showStatus('authStatus', 'Please sign in first', 'error');
                return false;
            }

            if (!silent) {
                showStatus('authStatus', 'üß™ Testing sheet access...', 'info');
            }
            
            try {
                // First, try to get sheet metadata
                const metaResponse = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: SHEET_ID
                });
                
                if (metaResponse.status === 200) {
                    const title = metaResponse.result.properties.title;
                    
                    // Test reading data
                    const dataResponse = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SHEET_ID,
                        range: 'Sheet1!A1:E1'
                    });
                    
                    if (dataResponse.status === 200) {
                        if (!silent) {
                            showStatus('authStatus', 
                                `‚úÖ Sheet access verified! Connected to "${title}". Ready to save data.`, 
                                'success'
                            );
                        }
                        return true;
                    }
                } else {
                    throw new Error('Failed to access sheet metadata');
                }
            } catch (error) {
                console.error('Sheet access error:', error);
                
                let errorMsg = `Sheet access failed: ${error.message}`;
                
                if (error.status === 404) {
                    errorMsg = 'Sheet not found. Check that the Sheet ID is correct.';
                } else if (error.status === 403) {
                    errorMsg = 'Permission denied. Make sure the sheet is shared with your Google account or is public.';
                } else if (error.message.includes('Invalid spreadsheet ID')) {
                    errorMsg = 'Invalid Sheet ID format. Check that you copied the correct ID from the Google Sheet URL.';
                }
                
                showStatus('authStatus', `‚ùå ${errorMsg}`, 'error');
                return false;
            }
        }

        // Enhanced data loading with better error handling
        async function loadData() {
            if (!isSignedIn) {
                showStatus('authStatus', 'Please sign in first', 'error');
                return;
            }

            document.getElementById('dataContainer').innerHTML = '<div class="flex items-center justify-center p-8"><div class="loading"></div><span class="ml-3 text-gray-600">Loading data...</span></div>';
            
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SHEET_ID,
                    range: 'Sheet1'
                });
                
                if (response.result.values && response.result.values.length > 0) {
                    currentData = response.result.values;
                    displayData(response.result.values);
                } else {
                    document.getElementById('dataContainer').innerHTML = `
                        <div class="bg-blue-50 border border-blue-200 rounded-md p-6 text-center">
                            <h3 class="text-lg font-medium text-blue-800 mb-2">üìÑ Empty Sheet</h3>
                            <p class="text-blue-700 mb-3">No data found. Make sure your sheet has headers in the first row:</p>
                            <div class="bg-white border border-blue-300 rounded p-3 text-sm font-mono text-blue-800">
                                Name | Email | Phone | Message | Timestamp
                            </div>
                            <p class="text-sm text-blue-600 mt-3">Add some data using the form above!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('dataContainer').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-md p-6">
                        <h3 class="text-lg font-medium text-red-800 mb-2">‚ùå Error Loading Data</h3>
                        <p class="text-red-700 mb-2"><strong>Error:</strong> ${error.message}</p>
                        <div class="text-sm text-red-600 space-y-1">
                            <p><strong>Possible solutions:</strong></p>
                            <ul class="list-disc list-inside ml-4 space-y-1">
                                <li>Check that the Sheet ID is correct</li>
                                <li>Ensure the sheet is accessible (shared or public)</li>
                                <li>Verify the sheet name is "Sheet1" or update the range</li>
                                <li>Make sure you have the correct permissions</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
        }

        // Enhanced save function
        async function saveToSheet(data) {
            if (!isSignedIn) {
                showStatus('formStatus', 'Please sign in first', 'error');
                return false;
            }

            try {
                // Check if sheet has headers first
                const headerResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SHEET_ID,
                    range: 'Sheet1!A1:E1'
                });

                // If no headers, add them first
                if (!headerResponse.result.values || headerResponse.result.values.length === 0) {
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: SHEET_ID,
                        range: 'Sheet1!A1:E1',
                        valueInputOption: 'USER_ENTERED',
                        resource: {
                            values: [['Name', 'Email', 'Phone', 'Message', 'Timestamp']]
                        }
                    });
                }

                const values = [[
                    data.name,
                    data.email, 
                    data.phone || '',
                    data.message || '',
                    data.timestamp
                ]];

                const response = await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SHEET_ID,
                    range: 'Sheet1!A:E',
                    valueInputOption: 'USER_ENTERED',
                    insertDataOption: 'INSERT_ROWS',
                    resource: {
                        values: values
                    }
                });

                if (response.status === 200) {
                    showStatus('formStatus', 'üéâ Data saved successfully to Google Sheet!', 'success');
                    setTimeout(() => loadData(), 1000); // Refresh after a short delay
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Save error:', error);
                
                let errorMsg = `Error saving data: ${error.message}`;
                if (error.status === 403) {
                    errorMsg = 'Permission denied. Make sure you have edit access to the Google Sheet.';
                } else if (error.status === 404) {
                    errorMsg = 'Sheet not found. Check your Sheet ID.';
                }
                
                showStatus('formStatus', `‚ùå ${errorMsg}`, 'error');
                return false;
            }
        }

        // Enhanced data display
        function displayData(data) {
            const headers = data[0];
            const rows = data.slice(1);
            
            if (rows.length === 0) {
                document.getElementById('dataContainer').innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-md p-6 text-center">
                        <h3 class="text-lg font-medium text-yellow-800 mb-2">üìã Headers Found</h3>
                        <p class="text-yellow-700 mb-3">Sheet is properly configured but no data entries yet.</p>
                        <div class="bg-white border border-yellow-300 rounded p-3 text-sm">
                            <strong>Headers:</strong> ${headers.join(' | ')}
                        </div>
                        <p class="text-sm text-yellow-600 mt-3">Start adding entries using the form above!</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-50">
                            <tr>
            `;
            
            headers.forEach(header => {
                html += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">${header || 'Column'}</th>`;
            });
            
            html += `
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            rows.forEach((row, index) => {
                html += `<tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50 transition-colors">`;
                headers.forEach((_, colIndex) => {
                    const cellValue = row[colIndex] || '';
                    const isEmail = headers[colIndex] === 'Email' && cellValue.includes('@');
                    const isPhone = headers[colIndex] === 'Phone' && cellValue;
                    
                    let cellContent = cellValue;
                    if (isEmail) {
                        cellContent = `<a href="mailto:${cellValue}" class="text-blue-600 hover:text-blue-800 underline">${cellValue}</a>`;
                    } else if (isPhone) {
                        cellContent = `<a href="tel:${cellValue}" class="text-blue-600 hover:text-blue-800 underline">${cellValue}</a>`;
                    }
                    
                    html += `<td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate" title="${cellValue}">${cellContent}</td>`;
                });
                html += `</tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-4 text-sm text-gray-600">
                    <p>üìä Total entries: <span class="font-semibold text-gray-800">${rows.length}</span></p>
                    <p>üïí Last updated: ${new Date().toLocaleTimeString()}</p>
                </div>
            `;
            
            document.getElementById('dataContainer').innerHTML = html;
        }

        // Export data as CSV
        function exportData() {
            if (currentData.length === 0) {
                showStatus('formStatus', 'No data to export', 'error');
                return;
            }

            const csvContent = currentData.map(row => 
                row.map(cell => `"${(cell || '').replace(/"/g, '""')}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `sheet-data-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus('formStatus', 'üì• Data exported successfully!', 'success');
        }

        // Handle form submission with validation
        document.getElementById('dataForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!isSignedIn) {
                showStatus('formStatus', 'Please sign in to Google first', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading"></div> Saving...';

            // Validate required fields
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            
            if (!name || !email) {
                showStatus('formStatus', 'Name and Email are required', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }

            const formData = {
                name: name,
                email: email,
                phone: document.getElementById('phone').value.trim(),
                message: document.getElementById('message').value.trim(),
                timestamp: new Date().toLocaleString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                })
            };

            const success = await saveToSheet(formData);
            
            if (success) {
                document.getElementById('dataForm').reset();
                // Focus back to name field for next entry
                document.getElementById('name').focus();
            }

            // Reset button
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });

        // Utility function to show enhanced status messages
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è'
            };
            
            const colorClass = `status-${type}`;
            const icon = icons[type] || '';
            
            element.innerHTML = `
                <div class="border-l-4 border-${type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue'}-400 bg-${type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue'}-50 p-4 rounded-md">
                    <p class="${colorClass} text-sm font-medium">${icon} ${message}</p>
                </div>
            `;
            
            if (type === 'success') {
                setTimeout(() => {
                    element.innerHTML = '';
                }, 5000);
            }
        }

        // Auto-save form data to prevent loss
        function saveFormData() {
            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                message: document.getElementById('message').value
            };
            // Store in memory only (no localStorage in Claude artifacts)
            window.tempFormData = formData;
        }

        function restoreFormData() {
            if (window.tempFormData) {
                document.getElementById('name').value = window.tempFormData.name || '';
                document.getElementById('email').value = window.tempFormData.email || '';
                document.getElementById('phone').value = window.tempFormData.phone || '';
                document.getElementById('message').value = window.tempFormData.message || '';
            }
        }

        // Add input listeners for auto-save
        ['name', 'email', 'phone', 'message'].forEach(field => {
            document.getElementById(field).addEventListener('input', saveFormData);
        });

        // Enhanced initialization
        window.onload = function() {
            // Update URL information
            updateURLInfo();
            
            // Disable submit button initially
            document.getElementById('submitBtn').disabled = true;
            
            // Restore any temporarily saved form data
            restoreFormData();
            
            // Show enhanced ready message
            document.getElementById('dataContainer').innerHTML = `
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-md p-6 text-center">
                    <div class="text-4xl mb-4">üöÄ</div>
                    <h3 class="text-lg font-medium text-blue-800 mb-2">Ready to Connect</h3>
                    <p class="text-sm text-blue-700 mb-3">Configure your OAuth settings above and click "Initialize & Sign In"</p>
                    <div class="text-xs text-blue-600 bg-white rounded p-2 border border-blue-300">
                        <strong>Current Origin:</strong> ${window.location.origin}
                    </div>
                </div>
            `;

            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl+Enter to save form
                if (e.ctrlKey && e.key === 'Enter' && !document.getElementById('submitBtn').disabled) {
                    document.getElementById('dataForm').dispatchEvent(new Event('submit'));
                }
                // F5 to refresh data (prevent default browser refresh)
                if (e.key === 'F5' && isSignedIn) {
                    e.preventDefault();
                    loadData();
                }
            });

            // Add helpful tooltips
            document.getElementById('clientId').title = 'Get this from Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials';
            document.getElementById('sheetId').title = 'Found in your Google Sheet URL between /d/ and /edit';
        };

        // Auto-refresh data every 30 seconds when signed in
        setInterval(() => {
            if (isSignedIn && document.visibilityState === 'visible') {
                loadData();
            }
        }, 30000);

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && isSignedIn) {
                loadData();
            }
        });
    </script>
</body>
</html>
