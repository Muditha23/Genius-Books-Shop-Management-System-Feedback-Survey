<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Entry Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-success { color: #10b981; }
        .status-error { color: #ef4444; }
        .status-info { color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Data Entry Dashboard</h1>
            <p class="text-gray-600">Enter data and save it directly to Google Sheets</p>
        </div>

        <!-- Configuration Panel -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Configuration</h2>
            
            <!-- Setup Instructions -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-6">
                <h3 class="text-sm font-medium text-yellow-800 mb-2">Setup Instructions:</h3>
                <ol class="text-sm text-yellow-700 list-decimal list-inside space-y-1">
                    <li>Go to <a href="https://console.cloud.google.com" target="_blank" class="underline">Google Cloud Console</a></li>
                    <li>Create project â†’ Enable Google Sheets API</li>
                    <li>Create OAuth2 Client ID (Web application)</li>
                    <li><strong>Add your domain to authorized origins:</strong> http://localhost AND http://127.0.0.1</li>
                    <li>Create a Google Sheet with headers: Name, Email, Phone, Message, Timestamp</li>
                </ol>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">OAuth2 Client ID</label>
                    <input type="text" id="clientId" 
                           value="722325759707-q8n7mh0454oktuh2smmkofdra7ojjrr7.apps.googleusercontent.com"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sheet ID</label>
                    <input type="text" id="sheetId" 
                           value="1UQMtwy3KuBOj8vuxCzXFEB79A8FDH784_nr5YZfBCzc"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div class="mt-4 space-x-4">
                <button onclick="initializeGoogleAPI()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition duration-200">
                    Initialize & Sign In
                </button>
                <button onclick="signOut()" 
                        class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-md transition duration-200">
                    Sign Out
                </button>
            </div>
            <div id="authStatus" class="mt-4"></div>
        </div>

        <!-- Data Entry Form -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Add New Entry</h2>
            <form id="dataForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                        <input type="text" id="name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="email" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                        <input type="tel" id="phone" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                    <textarea id="message" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" id="submitBtn"
                        class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-md transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Save to Google Sheet
                </button>
            </form>
            <div id="formStatus" class="mt-4"></div>
        </div>

        <!-- Data Display -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Current Data</h2>
                <button onclick="loadData()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition duration-200">
                    Refresh Data
                </button>
            </div>
            <div id="dataContainer">
                <p class="text-gray-500">Sign in and connect to view your Google Sheet data</p>
            </div>
        </div>
    </div>

    <script>
        let SHEET_ID = '';
        let isSignedIn = false;
        let tokenClient = null;
        let accessToken = null;

        // Initialize Google API with proper GIS implementation
        async function initializeGoogleAPI() {
            const clientId = document.getElementById('clientId').value;
            SHEET_ID = document.getElementById('sheetId').value;
            
            if (!clientId || !SHEET_ID) {
                showStatus('authStatus', 'Please enter both Client ID and Sheet ID', 'error');
                return;
            }

            showStatus('authStatus', 'Initializing Google API...', 'info');

            try {
                // Load the Google API client first
                await new Promise((resolve, reject) => {
                    gapi.load('client', { 
                        callback: resolve, 
                        onerror: () => reject(new Error('Failed to load Google API client'))
                    });
                });

                // Initialize the GAPI client (without auth)
                await gapi.client.init({
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                });

                // Initialize the token client using GIS
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: clientId,
                    scope: 'https://www.googleapis.com/auth/spreadsheets',
                    prompt: 'consent',
                    callback: (response) => {
                        if (response.error) {
                            console.error('Token error:', response);
                            showStatus('authStatus', `Authentication failed: ${response.error}`, 'error');
                            return;
                        }
                        
                        // Set the access token
                        accessToken = response.access_token;
                        gapi.client.setToken({access_token: accessToken});
                        handleSignIn();
                    },
                    error_callback: (error) => {
                        console.error('OAuth error:', error);
                        showStatus('authStatus', `OAuth error: ${error.message || 'Unknown error'}`, 'error');
                    }
                });

                // Request access token
                tokenClient.requestAccessToken({prompt: 'consent'});

            } catch (error) {
                console.error('Initialization error:', error);
                
                if (error.error === 'idpiframe_initialization_failed' || 
                    (error.details && error.details.includes('not been registered'))) {
                    showStatus('authStatus', `Origin not authorized. Please add ${window.location.origin} to your OAuth2 client's authorized JavaScript origins in Google Cloud Console.`, 'error');
                } else {
                    showStatus('authStatus', `Initialization error: ${error.message || error.details || 'Please check your Client ID and ensure the origin is authorized'}`, 'error');
                }
            }
        }

        // Handle successful sign in
        function handleSignIn() {
            isSignedIn = true;
            showStatus('authStatus', 'Successfully authenticated! You can now save data to Google Sheets.', 'success');
            document.getElementById('submitBtn').disabled = false;
            loadData();
        }

        // Sign out
        function signOut() {
            if (accessToken) {
                // Revoke the access token
                google.accounts.oauth2.revoke(accessToken, () => {
                    console.log('Token revoked');
                });
            }
            
            // Clear local state
            isSignedIn = false;
            accessToken = null;
            tokenClient = null;
            
            // Clear the token from gapi client
            gapi.client.setToken(null);
            
            showStatus('authStatus', 'Signed out successfully', 'info');
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('dataContainer').innerHTML = '<p class="text-gray-500">Sign in to view your Google Sheet data</p>';
        }

        // Load data from Google Sheet
        async function loadData() {
            if (!isSignedIn) {
                showStatus('authStatus', 'Please sign in first', 'error');
                return;
            }

            document.getElementById('dataContainer').innerHTML = '<div class="loading"></div> Loading data...';
            
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SHEET_ID,
                    range: 'Sheet1'
                });
                
                if (response.result.values && response.result.values.length > 0) {
                    displayData(response.result.values);
                } else {
                    document.getElementById('dataContainer').innerHTML = `
                        <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                            <p class="text-blue-800">No data found. Make sure your sheet has headers in the first row:</p>
                            <p class="text-sm text-blue-600 mt-2 font-mono">Name | Email | Phone | Message | Timestamp</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('dataContainer').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-md p-4">
                        <p class="text-red-800">Error loading data: ${error.message}</p>
                        <p class="text-sm text-red-600 mt-2">Check that the Sheet ID is correct and the sheet is accessible.</p>
                    </div>
                `;
            }
        }

        // Save data to Google Sheet
        async function saveToSheet(data) {
            if (!isSignedIn) {
                showStatus('formStatus', 'Please sign in first', 'error');
                return false;
            }

            try {
                const values = [[
                    data.name,
                    data.email, 
                    data.phone || '',
                    data.message || '',
                    data.timestamp
                ]];

                const response = await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SHEET_ID,
                    range: 'Sheet1!A:E',
                    valueInputOption: 'USER_ENTERED',
                    insertDataOption: 'INSERT_ROWS',
                    resource: {
                        values: values
                    }
                });

                if (response.status === 200) {
                    showStatus('formStatus', 'Data saved successfully to Google Sheet!', 'success');
                    loadData(); // Refresh the display
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Save error:', error);
                showStatus('formStatus', `Error saving data: ${error.message}`, 'error');
                return false;
            }
        }

        // Display data in table format
        function displayData(data) {
            const headers = data[0];
            const rows = data.slice(1);
            
            let html = `
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-50">
                            <tr>
            `;
            
            headers.forEach(header => {
                html += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header || 'Column'}</th>`;
            });
            
            html += `
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            rows.forEach((row, index) => {
                html += `<tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">`;
                headers.forEach((_, colIndex) => {
                    html += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row[colIndex] || ''}</td>`;
                });
                html += `</tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <p class="text-sm text-gray-500 mt-4">Total entries: ${rows.length}</p>
            `;
            
            document.getElementById('dataContainer').innerHTML = html;
        }

        // Handle form submission
        document.getElementById('dataForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!isSignedIn) {
                showStatus('formStatus', 'Please sign in to Google first', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading"></div> Saving...';

            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                message: document.getElementById('message').value,
                timestamp: new Date().toLocaleString()
            };

            const success = await saveToSheet(formData);
            
            if (success) {
                // Clear form
                document.getElementById('dataForm').reset();
            }

            // Reset button
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Save to Google Sheet';
        });

        // Utility function to show status messages
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            const colorClass = `status-${type}`;
            element.innerHTML = `<p class="${colorClass} text-sm mt-2">${message}</p>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    element.innerHTML = '';
                }, 5000);
            }
        }

        // Test Sheet Access
        async function testSheetAccess() {
            if (!isSignedIn) {
                showStatus('authStatus', 'Please sign in first', 'error');
                return;
            }

            try {
                showStatus('authStatus', 'Testing sheet access...', 'info');
                
                // Try to get sheet metadata
                const response = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: SHEET_ID
                });
                
                if (response.status === 200) {
                    showStatus('authStatus', `Sheet access verified! Sheet title: "${response.result.properties.title}"`, 'success');
                } else {
                    throw new Error('Failed to access sheet');
                }
            } catch (error) {
                console.error('Sheet access error:', error);
                showStatus('authStatus', `Sheet access failed: ${error.message}. Check that the Sheet ID is correct and the sheet is shared with your account.`, 'error');
            }
        }

        // Initialize on page load
        window.onload = function() {
            // Disable submit button initially
            document.getElementById('submitBtn').disabled = true;
            
            // Show instructions with current URL info
            document.getElementById('dataContainer').innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                    <h3 class="text-sm font-medium text-blue-800 mb-2">Ready to Connect</h3>
                    <p class="text-sm text-blue-700 mb-2">Your current URL: <code class="bg-white px-1 rounded">${window.location.origin}</code></p>
                    <p class="text-sm text-blue-700">Make sure this URL is added to your OAuth2 client's authorized JavaScript origins, then click "Initialize & Sign In".</p>
                </div>
            `;
            
            // Add test button after initialization
            const configPanel = document.querySelector('.bg-white.rounded-lg.shadow-md.p-6.mb-8:nth-child(2)');
            if (configPanel) {
                const buttonContainer = configPanel.querySelector('.mt-4.space-x-4');
                if (buttonContainer) {
                    const testButton = document.createElement('button');
                    testButton.onclick = testSheetAccess;
                    testButton.className = 'bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-md transition duration-200';
                    testButton.textContent = 'Test Sheet Access';
                    buttonContainer.appendChild(testButton);
                }
            }
        };
    </script>
</body>
</html>
